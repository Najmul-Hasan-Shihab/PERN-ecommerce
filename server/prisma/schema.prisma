generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ─── Users ───────────────────────────────────────────────

model User {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String   @unique @db.VarChar(255)
  first_name    String   @db.VarChar(100)
  last_name     String   @db.VarChar(100)
  password_hash String   @db.VarChar(255)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  addresses UserAddress[]
  cart      Cart?
  orders    Order[]
  reviews   Review[]

  @@map("users")
}

model UserAddress {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id       String   @db.Uuid
  full_name     String   @db.VarChar(200)
  address_label String?  @db.VarChar(50)
  address_line1 String   @db.VarChar(255)
  address_line2 String?  @db.VarChar(255)
  city          String   @db.VarChar(100)
  state         String   @db.VarChar(100)
  postal_code   String   @db.VarChar(20)
  country       String   @db.VarChar(100)
  phone_number  String   @db.VarChar(50)
  is_default    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@map("user_addresses")
}

// ─── Categories ──────────────────────────────────────────

model Category {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @db.VarChar(100)
  slug        String   @unique @db.VarChar(255)
  parent_id   String?  @db.Uuid
  description String?  @db.Text
  image_url   String   @db.VarChar(255)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  parent   Category?  @relation("CategoryTree", fields: [parent_id], references: [id])
  children Category[] @relation("CategoryTree")

  products Product[]

  @@map("categories")
}

// ─── Products ────────────────────────────────────────────

model Product {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  category_id     String   @db.Uuid
  title           String   @db.VarChar(255)
  slug            String   @unique @db.VarChar(255)
  description     String?  @db.Text
  base_price      Decimal  @db.Decimal(10, 2)
  original_price  Decimal? @db.Decimal(10, 2)
  stock_quantity  Int      @default(0)
  specifications  Json?    @db.JsonB
  is_featured     Boolean  @default(false)
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt

  category   Category        @relation(fields: [category_id], references: [id])
  images     ProductImage[]
  variants   ProductVariant[]
  cart_items CartItem[]
  reviews    Review[]

  @@map("products")
}

model ProductImage {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  product_id    String   @db.Uuid
  image_url     String   @db.VarChar(255)
  alt_text      String?  @db.VarChar(255)
  display_order Int      @default(0)
  is_primary    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  product Product @relation(fields: [product_id], references: [id])

  @@map("product_images")
}

model ProductVariant {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  product_id       String   @db.Uuid
  variant_name     String   @db.VarChar(50)
  variant_value    String   @db.VarChar(50)
  price_adjustment Decimal  @default(0.00) @db.Decimal(10, 2)
  stock_quantity   Int      @default(0)
  image_url        String?  @db.VarChar(255)

  product    Product    @relation(fields: [product_id], references: [id])
  cart_items CartItem[]

  @@map("product_variants")
}

// ─── Cart ────────────────────────────────────────────────

model Cart {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String?  @unique @db.Uuid
  session_id String?  @db.VarChar(255)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  user  User?      @relation(fields: [user_id], references: [id])
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cart_id    String   @db.Uuid
  product_id String   @db.Uuid
  variant_id String?  @db.Uuid
  quantity   Int      @default(1)
  added_at   DateTime @default(now())

  cart    Cart            @relation(fields: [cart_id], references: [id])
  product Product         @relation(fields: [product_id], references: [id])
  variant ProductVariant? @relation(fields: [variant_id], references: [id])

  @@map("cart_items")
}

// ─── Orders ──────────────────────────────────────────────

model Order {
  id                        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id                   String   @db.Uuid
  status                    String   @db.VarChar(50)
  total_amount              Decimal  @db.Decimal(10, 2)
  shipping_address_snapshot Json     @db.JsonB
  payment_method            String   @db.VarChar(50)
  payment_status            String   @default("pending") @db.VarChar(50)
  created_at                DateTime @default(now())
  updated_at                DateTime @default(now()) @updatedAt

  user  User        @relation(fields: [user_id], references: [id])
  items OrderItem[]

  @@map("orders")
}

model OrderItem {
  id                String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  order_id          String  @db.Uuid
  product_id        String? @db.Uuid
  product_snapshot  Json    @db.JsonB
  variant_snapshot  Json    @db.JsonB
  quantity          Int
  price_at_purchase Decimal @db.Decimal(10, 2)
  total_price       Decimal @db.Decimal(10, 2)

  order Order @relation(fields: [order_id], references: [id])

  @@map("order_items")
}

// ─── Reviews ─────────────────────────────────────────────

model Review {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  product_id           String   @db.Uuid
  user_id              String   @db.Uuid
  rating               Int
  comment              String?  @db.Text
  is_verified_purchase Boolean  @default(false)
  created_at           DateTime @default(now())

  product Product @relation(fields: [product_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  @@map("reviews")
}
